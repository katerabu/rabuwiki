<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>rpinvme</title></head>
<body>
<h1>ğŸ›¡ï¸ Raspberry Pi 5: PÅ™esun systÃ©mu na NVMe + Å ifrovanÃ© zÃ¡lohovacÃ­ kontejnery</h1>
<h2>ğŸ§¾ CÃ­l</h2>
<ul>
<li>PÅ™esunout systÃ©m ze SD karty na NVMe disk (Raspberry Pi 5).</li>
<li>Nastavit dva Å¡ifrovanÃ© kontejnery na NVMe disku pro zÃ¡lohovÃ¡nÃ­ (napÅ™. pÅ™es <code>rsync</code> nebo <code>borg</code>).</li>
<li>Provoz pouze v rÃ¡mci lokÃ¡lnÃ­ sÃ­tÄ›, dva uÅ¾ivatelÃ©, pÅ™Ã­stup pÅ™es SSH.</li>
</ul>
<hr />
<h2>1ï¸âƒ£ PÅ™Ã­prava</h2>
<h3>Nutnosti:</h3>
<ul>
<li>Raspberry Pi 5 s bootloaderem podporujÃ­cÃ­m NVMe.</li>
<li>FunkÄnÃ­ systÃ©m na SD kartÄ› (<code>Raspberry Pi OS</code> doporuÄeno).</li>
<li>NVMe disk sprÃ¡vnÄ› rozpoznÃ¡n (<code>lsblk</code> / <code>blkid</code>).</li>
<li>ZÃ¡loha systÃ©mu pÅ™ed jakoukoliv operacÃ­ (napÅ™. pomocÃ­ <code>rpi-clone</code> nebo <code>dd</code>).</li>
</ul>
<hr />
<h2>2ï¸âƒ£ PÅ™esun systÃ©mu na NVMe</h2>
<h3>a) Zjisti zaÅ™Ã­zenÃ­</h3>
<pre><code class="language-bash">lsblk
</code></pre>
<p>SD karta bude napÅ™. <code>/dev/mmcblk0</code>, NVMe disk <code>/dev/nvme0n1</code>.</p>
<h3>b) ZkopÃ­ruj celÃ½ systÃ©m</h3>
<pre><code class="language-bash">sudo apt update &amp;&amp; sudo apt install rsync
sudo mkdir /mnt/nvme
sudo mount /dev/nvme0n1p1 /mnt/nvme   # pÅ™Ã­padnÄ› vytvoÅ™ oddÃ­l + fs
sudo rsync -aAXv / /mnt/nvme --exclude={&quot;/dev/*&quot;,&quot;/proc/*&quot;,&quot;/sys/*&quot;,&quot;/tmp/*&quot;,&quot;/run/*&quot;,&quot;/mnt/*&quot;,&quot;/media/*&quot;,&quot;/lost+found&quot;}
</code></pre>
<h3>c) Aktualizuj <code>/mnt/nvme/etc/fstab</code></h3>
<p>Uprav zÃ¡znamy podle novÃ©ho UUID disku (<code>sudo blkid</code>).</p>
<pre><code class="language-bash">UUID=xxxxxx / ext4 defaults,noatime 0 1
</code></pre>
<h3>d) Nastav boot z NVMe</h3>
<p>Pokud mÃ¡Å¡ novÃ½ bootloader (2023+), staÄÃ­ odpojit SD kartu. Pokud ne:
- Nainstaluj <code>rpi-eeprom</code> a spusÅ¥ <code>sudo raspi-config</code> &gt; Advanced &gt; Boot Order &gt; NVMe.</p>
<hr />
<h2>3ï¸âƒ£ VytvoÅ™enÃ­ Å¡ifrovanÃ½ch kontejnerÅ¯</h2>
<h3>a) Instalace potÅ™ebnÃ½ch balÃ­ÄkÅ¯</h3>
<pre><code class="language-bash">sudo apt install cryptsetup
</code></pre>
<h3>b) VytvoÅ™enÃ­ dvou Å¡ifrovanÃ½ch souborÅ¯ (napÅ™. 10 GB)</h3>
<pre><code class="language-bash">cd /backup

# Kontejner 1
fallocate -l 10G container_user1.img
cryptsetup luksFormat container_user1.img
cryptsetup luksOpen container_user1.img user1_backup
mkfs.ext4 /dev/mapper/user1_backup
mkdir /mnt/user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

# Kontejner 2
fallocate -l 10G container_user2.img
cryptsetup luksFormat container_user2.img
cryptsetup luksOpen container_user2.img user2_backup
mkfs.ext4 /dev/mapper/user2_backup
mkdir /mnt/user2_backup
mount /dev/mapper/user2_backup /mnt/user2_backup
</code></pre>
<p>Po pÅ™ipojenÃ­:</p>
<pre><code class="language-bash"># PÅ™Ã­stup k nim pÅ™es mountpoint
/mnt/user1_backup
/mnt/user2_backup
</code></pre>
<h3>c) ZapsÃ¡nÃ­ automount skriptu (volitelnÄ›)</h3>
<p>VytvoÅ™ skript pro ruÄnÃ­ pÅ™ipojenÃ­:</p>
<pre><code class="language-bash">sudo nano /usr/local/bin/mount_backups.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

cryptsetup luksOpen /backup/container_user2.img user2_backup
mount /dev/mapper/user2_backup /mnt/user2_backup
</code></pre>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/mount_backups.sh
</code></pre>
<hr />
<h2>4ï¸âƒ£ NastavenÃ­ zÃ¡lohovÃ¡nÃ­</h2>
<h3>MoÅ¾nost A: Rsync pÅ™es SSH</h3>
<p>Na klientu (napÅ™. pracovnÃ­ stanice):</p>
<pre><code class="language-bash">rsync -a --delete /data/ user@raspberrypi:/mnt/user1_backup/
</code></pre>
<h3>MoÅ¾nost B: BorgBackup</h3>
<p>Na RPi:</p>
<pre><code class="language-bash">sudo apt install borgbackup
</code></pre>
<p>Na klientu:</p>
<pre><code class="language-bash">borg init --encryption=repokey-blake2 user@raspberrypi:/mnt/user1_backup
borg create -v --stats ::{hostname}-{now:%Y-%m-%d} /data
</code></pre>
<hr />
<h2>5ï¸âƒ£ UÅ¾ivatelÃ© a pÅ™Ã­stup</h2>
<p>PÅ™Ã­stup pÅ™es SSHFS nebo rsync pÅ™es SSH â€” nenÃ­ potÅ™eba nic dalÅ¡Ã­ho, staÄÃ­ zajistit:
- UÅ¾ivatel mÃ¡ pÅ™Ã­stup na <code>/mnt/userX_backup</code>.
- Autentizace klÃ­Äem, zamykÃ¡nÃ­ kontejnerÅ¯ dle potÅ™eby.</p>
<hr />
<h2>6ï¸âƒ£ ZabezpeÄenÃ­</h2>
<ul>
<li>LUKS Å¡ifrovÃ¡nÃ­ â€” AES-XTS-PLAIN64, silnÃ© heslo nebo klÃ­Ä.</li>
<li>NVMe lze i plnÄ› zaÅ¡ifrovat (LUKS pÅ™es celÃ½ disk), ale zde je zvolen kontejner pro flexibilitu.</li>
<li>PravidelnÃ© zÃ¡lohovÃ¡nÃ­ <code>mount + rsync/borg</code> jako cronjob (spuÅ¡tÄ›no jen kdyÅ¾ mount existuje).</li>
</ul>
<hr />
<h2>7ï¸âƒ£ AutomatickÃ© pÅ™ipojovÃ¡nÃ­ kontejnerÅ¯ pomocÃ­ systemd</h2>
<p>Pro pohodlnÃ© pÅ™ipojenÃ­ kontejnerÅ¯ po startu nebo ruÄnÄ› pÅ™es <code>systemctl</code>, vytvoÅ™ dva <code>systemd</code> jednotkovÃ© soubory pro Å¡ifrovanÃ© kontejnery.</p>
<h3>a) <code>cryptsetup</code> jednotky</h3>
<pre><code class="language-bash">sudo nano /etc/crypttab
</code></pre>
<p>PÅ™idej:</p>
<pre><code>user1_backup /backup/container_user1.img none luks
user2_backup /backup/container_user2.img none luks
</code></pre>
<blockquote>
<p>âš ï¸ <code>none</code> znamenÃ¡ ruÄnÃ­ zadÃ¡nÃ­ hesla pÅ™i pÅ™ipojovÃ¡nÃ­. MÅ¯Å¾eÅ¡ nahradit cestou ke klÃ­Äi, napÅ™. <code>/etc/keys/user1.key</code>.</p>
</blockquote>
<h3>b) Mount jednotky</h3>
<p>VytvoÅ™ mount jednotky, kterÃ© se aktivujÃ­ aÅ¾ po odemÄenÃ­.</p>
<pre><code class="language-bash">sudo nano /etc/systemd/system/mnt-user1_backup.mount
</code></pre>
<pre><code class="language-ini">[Unit]
Description=Mount user1 backup container
Requires=dev-mapper-user1_backup.device
After=dev-mapper-user1_backup.device

[Mount]
What=/dev/mapper/user1_backup
Where=/mnt/user1_backup
Type=ext4
Options=defaults

[Install]
WantedBy=multi-user.target
</code></pre>
<p>TotÃ©Å¾ pro <code>user2_backup</code>:</p>
<pre><code class="language-bash">sudo nano /etc/systemd/system/mnt-user2_backup.mount
</code></pre>
<p>Potom:</p>
<pre><code class="language-bash">sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable mnt-user1_backup.mount
sudo systemctl enable mnt-user2_backup.mount
</code></pre>
<p>PÅ™ipojenÃ­ provedeno ruÄnÄ› (napÅ™. po rebootu):</p>
<pre><code class="language-bash">sudo systemctl start mnt-user1_backup.mount
sudo systemctl start mnt-user2_backup.mount
</code></pre>
<hr />
<h2>8ï¸âƒ£ Cron zÃ¡lohovÃ¡nÃ­ v noci</h2>
<p>NaplÃ¡nujeme dennÃ­ noÄnÃ­ zÃ¡lohu v <code>crontab</code>. NapÅ™. ve 2:00 rÃ¡no.</p>
<h3>a) Rsync varianta</h3>
<p>SpusÅ¥:</p>
<pre><code class="language-bash">crontab -e
</code></pre>
<p>PÅ™idej:</p>
<pre><code>0 2 * * * /usr/local/bin/zalohuj_user1.sh
</code></pre>
<p>VytvoÅ™ skript:</p>
<pre><code class="language-bash">sudo nano /usr/local/bin/zalohuj_user1.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup
rsync -a --delete /data/ /mnt/user1_backup/
umount /mnt/user1_backup
cryptsetup luksClose user1_backup
</code></pre>
<p>UdÄ›lej spustitelnÃ½:</p>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/zalohuj_user1.sh
</code></pre>
<p>TotÃ©Å¾ mÅ¯Å¾eÅ¡ udÄ›lat pro <code>user2</code>.</p>
<h3>b) BorgBackup varianta</h3>
<p>Skript:</p>
<pre><code class="language-bash">sudo nano /usr/local/bin/borg_zalohuj_user1.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
export BORG_REPO=/mnt/user1_backup
export BORG_PASSPHRASE='TVOJE_HESLO'  # nebo pouÅ¾ij environment file

cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

borg create --compression zstd,5 --stats ::'{hostname}-{now:%Y-%m-%d}' /data

borg prune -v --keep-daily=7 --keep-weekly=4 --keep-monthly=6

umount /mnt/user1_backup
cryptsetup luksClose user1_backup
</code></pre>
<p>PÅ™idÃ¡Å¡ opÄ›t do <code>crontab</code>:</p>
<pre><code>0 2 * * * /usr/local/bin/borg_zalohuj_user1.sh
</code></pre>
<blockquote>
<p>âš ï¸ LepÅ¡Ã­ zabezpeÄenÃ­: hesla uchovÃ¡vej mimo skript, napÅ™. v <code>~/.borg-passphrase</code>.</p>
</blockquote>
<hr />
<h2>ğŸ” Bonus: PouÅ¾itÃ­ klÃ­ÄovÃ½ch souborÅ¯ mÃ­sto hesel</h2>
<p>MÃ­sto ruÄnÃ­ho zadÃ¡vÃ¡nÃ­ hesla mÅ¯Å¾eÅ¡ pro LUKS pouÅ¾Ã­t klÃ­Ä:</p>
<pre><code class="language-bash">sudo dd if=/dev/urandom of=/etc/keys/user1.key bs=4096 count=1
sudo chmod 400 /etc/keys/user1.key
cryptsetup luksAddKey /backup/container_user1.img /etc/keys/user1.key
</code></pre>
<p>Pak aktualizuj <code>/etc/crypttab</code>:</p>
<pre><code>user1_backup /backup/container_user1.img /etc/keys/user1.key luks
</code></pre>
<hr />
<h2>ğŸ§¼ Ãšklid a testovÃ¡nÃ­</h2>
<ul>
<li>Otestuj ruÄnÄ›: <code>sudo systemctl start mnt-user1_backup.mount</code></li>
<li>Otestuj cron job pomocÃ­ <code>sudo run-parts /etc/cron.daily/</code> nebo simuluj pomocÃ­ <code>at</code>.</li>
</ul>
<hr />
<h2>âœ… CelkovÃ½ stav</h2>
<ul>
<li>SystÃ©m bÄ›Å¾Ã­ z NVMe disku.</li>
<li>ZÃ¡lohy probÃ­hajÃ­ automaticky v noci.</li>
<li>Jsou Å¡ifrovanÃ© a bezpeÄnÃ©.</li>
<li>MÅ¯Å¾eÅ¡ kdykoliv zÃ¡lohovat ruÄnÄ› nebo automaticky.</li>
<li>PÅ™Ã­stup moÅ¾nÃ½ pouze z LAN (napÅ™. pÅ™es SSH).</li>
</ul>
<p><a href="../index.html">â† ZpÄ›t na pÅ™ehled</a></p>
</body>
</html>