<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>rpinvme</title></head>
<body>
<h2>ğŸ›¡ï¸ Raspberry Pi 5: PÅ™esun systÃ©mu na NVMe + Å ifrovanÃ© zÃ¡lohovacÃ­ kontejnery</h2>
<hr />
<h3>ğŸ“¢ ÃšvodnÃ­ banner</h3>
<blockquote>
<p><strong>Pozor:</strong> Tento nÃ¡vod pÅ™edpoklÃ¡dÃ¡ zÃ¡kladnÃ­ znalost Linuxu, prÃ¡ce s terminÃ¡lem a zÃ¡lohovÃ¡nÃ­ dat.<br />
PÅ™ed zahÃ¡jenÃ­m operacÃ­ vÅ¾dy proveÄ kompletnÃ­ zÃ¡lohu stÃ¡vajÃ­cÃ­ho systÃ©mu.<br />
NesprÃ¡vnÃ© pouÅ¾itÃ­ mÅ¯Å¾e vÃ©st ke ztrÃ¡tÄ› dat!</p>
</blockquote>
<hr />
<h3>ğŸ“¦ Seznam nutnÃ½ch balÃ­ÄkÅ¯</h3>
<p>Instaluj je pÅ™edem, pokud jeÅ¡tÄ› nejsou:</p>
<pre><code class="language-bash">sudo apt update
sudo apt install rsync cryptsetup borgbackup parted
</code></pre>
<hr />
<h3>1ï¸âƒ£ PÅ™Ã­prava</h3>
<h4>Nutnosti:</h4>
<ul>
<li>Raspberry Pi 5 s bootloaderem podporujÃ­cÃ­m NVMe (vÄ›tÅ¡ina po roce 2023).</li>
<li>FunkÄnÃ­ systÃ©m na SD kartÄ› (<code>Raspberry Pi OS</code> 64bit doporuÄeno).</li>
<li>NVMe disk fyzicky pÅ™ipojen a sprÃ¡vnÄ› detekovÃ¡n (<code>lsblk</code>, <code>blkid</code>).</li>
<li>ZÃ¡loha systÃ©mu pÅ™ed jakoukoliv operacÃ­: napÅ™. pomocÃ­ <code>rpi-clone</code>, <code>dd</code> nebo externÃ­ kopie na jinÃ½ disk.</li>
<li>PoÄÃ­tej s potÅ™ebou jednoho restartu po zmÄ›nÄ› diskovÃ½ch oddÃ­lÅ¯ (kvÅ¯li informovÃ¡nÃ­ kernelu).</li>
</ul>
<hr />
<h3>2ï¸âƒ£ PÅ™esun systÃ©mu na NVMe</h3>
<h4>a) OvÄ›Å™ pÅ™ipojenÃ­ zaÅ™Ã­zenÃ­</h4>
<pre><code class="language-bash">lsblk
</code></pre>
<p>Hledej:
- SD karta = <code>/dev/mmcblk0</code>
- NVMe = <code>/dev/nvme0n1</code></p>
<h4>b) VymaÅ¾ a znovu vytvoÅ™ oddÃ­ly na NVMe</h4>
<pre><code class="language-bash">sudo umount /dev/nvme0n1*
sudo parted /dev/nvme0n1 mklabel gpt
sudo parted /dev/nvme0n1 mkpart primary ext4 0% 100%
sudo mkfs.ext4 /dev/nvme0n1p1
</code></pre>
<h4>c) PÅ™ipoj novÃ½ oddÃ­l a zkopÃ­ruj systÃ©m</h4>
<pre><code class="language-bash">sudo mkdir /mnt/nvme
sudo mount /dev/nvme0n1p1 /mnt/nvme
sudo rsync -aAXv / /mnt/nvme --exclude={&quot;/dev/*&quot;,&quot;/proc/*&quot;,&quot;/sys/*&quot;,&quot;/tmp/*&quot;,&quot;/run/*&quot;,&quot;/mnt/*&quot;,&quot;/media/*&quot;,&quot;/lost+found&quot;}
</code></pre>
<h4>d) Aktualizuj <code>fstab</code> v novÃ©m systÃ©mu</h4>
<p>Zjisti UUID:</p>
<pre><code class="language-bash">sudo blkid
</code></pre>
<p>Pak uprav <code>/mnt/nvme/etc/fstab</code>:</p>
<pre><code>UUID=XXXX-XXXX / ext4 defaults,noatime 0 1
</code></pre>
<h4>e) Aktivuj boot z NVMe</h4>
<p>BuÄ:
- Odpoj SD kartu a restartuj (funguje u novÃ©ho bootloaderu),
nebo:
- SpusÅ¥ <code>sudo raspi-config</code> &gt; Advanced Options &gt; Boot Order &gt; NVMe
- PÅ™Ã­padnÄ› nainstaluj <code>rpi-eeprom</code> a zkontroluj firmware</p>
<hr />
<h3>3ï¸âƒ£ VytvoÅ™enÃ­ Å¡ifrovanÃ½ch zÃ¡lohovacÃ­ch kontejnerÅ¯</h3>
<h4>a) Instaluj <code>cryptsetup</code></h4>
<pre><code class="language-bash">sudo apt install cryptsetup
</code></pre>
<h4>b) VytvoÅ™ Å¡ifrovanÃ© soubory</h4>
<pre><code class="language-bash">cd /backup

# Kontejner 1
fallocate -l 10G container_user1.img
cryptsetup luksFormat container_user1.img
cryptsetup luksOpen container_user1.img user1_backup
mkfs.ext4 /dev/mapper/user1_backup
mkdir /mnt/user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

# Kontejner 2
fallocate -l 10G container_user2.img
cryptsetup luksFormat container_user2.img
cryptsetup luksOpen container_user2.img user2_backup
mkfs.ext4 /dev/mapper/user2_backup
mkdir /mnt/user2_backup
mount /dev/mapper/user2_backup /mnt/user2_backup
</code></pre>
<h4>c) VolitelnÃ½ ruÄnÃ­ mount skript</h4>
<pre><code class="language-bash">sudo nano /usr/local/bin/mount_backups.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup
cryptsetup luksOpen /backup/container_user2.img user2_backup
mount /dev/mapper/user2_backup /mnt/user2_backup
</code></pre>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/mount_backups.sh
</code></pre>
<hr />
<h3>4ï¸âƒ£ ZÃ¡lohovÃ¡nÃ­</h3>
<h4>a) Rsync (klient â†’ RPi)</h4>
<pre><code class="language-bash">rsync -a --delete /data/ user@raspberrypi:/mnt/user1_backup/
</code></pre>
<h4>b) BorgBackup (modernÃ­ zpÅ¯sob)</h4>
<p>Na RPi:</p>
<pre><code class="language-bash">sudo apt install borgbackup
</code></pre>
<p>Na klientu:</p>
<pre><code class="language-bash">borg init --encryption=repokey-blake2 user@raspberrypi:/mnt/user1_backup
borg create -v --stats ::{hostname}-{now:%Y-%m-%d} /data
</code></pre>
<hr />
<h3>5ï¸âƒ£ PÅ™Ã­stup uÅ¾ivatelÅ¯</h3>
<ul>
<li>PÅ™Ã­stup pÅ™es SSH.</li>
<li>UÅ¾ivatel mÃ¡ prÃ¡vo ÄÃ­st/zapisovat do <code>/mnt/userX_backup</code>.</li>
<li>PouÅ¾Ã­vej klÃ­Äovou autentizaci.</li>
</ul>
<hr />
<h3>6ï¸âƒ£ BezpeÄnost</h3>
<ul>
<li>AES-XTS 512bit pomocÃ­ LUKS.</li>
<li>Kontejnery = snadno pÅ™enositelnÃ© + flexibilnÃ­.</li>
<li>Lze pouÅ¾Ã­t celÃ½ disk (LUKS pÅ™es <code>/dev/nvme0n1</code>), ale mÃ©nÄ› flexibilnÃ­.</li>
<li>DoporuÄujeme zÃ¡lohovat mimo RPi (napÅ™. NAS).</li>
</ul>
<hr />
<h3>7ï¸âƒ£ Automount pÅ™es systemd</h3>
<h4>a) crypttab</h4>
<pre><code class="language-bash">sudo nano /etc/crypttab
</code></pre>
<pre><code>user1_backup /backup/container_user1.img none luks
user2_backup /backup/container_user2.img none luks
</code></pre>
<p>Pokud chceÅ¡ pouÅ¾Ã­t klÃ­ÄovÃ½ soubor:</p>
<pre><code class="language-bash">sudo mkdir -p /etc/keys
sudo dd if=/dev/urandom of=/etc/keys/user1.key bs=4096 count=1
sudo chmod 400 /etc/keys/user1.key
cryptsetup luksAddKey /backup/container_user1.img /etc/keys/user1.key
</code></pre>
<p>Pak do <code>crypttab</code>:</p>
<pre><code>user1_backup /backup/container_user1.img /etc/keys/user1.key luks
</code></pre>
<h4>b) mount jednotky</h4>
<pre><code class="language-bash">sudo nano /etc/systemd/system/mnt-user1_backup.mount
</code></pre>
<pre><code class="language-ini">[Unit]
Description=Mount user1 backup container
Requires=dev-mapper-user1_backup.device
After=dev-mapper-user1_backup.device

[Mount]
What=/dev/mapper/user1_backup
Where=/mnt/user1_backup
Type=ext4
Options=defaults

[Install]
WantedBy=multi-user.target
</code></pre>
<p>TotÃ©Å¾ pro user2:</p>
<pre><code class="language-bash">sudo nano /etc/systemd/system/mnt-user2_backup.mount
</code></pre>
<p>Aktivace:</p>
<pre><code class="language-bash">sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable mnt-user1_backup.mount
sudo systemctl enable mnt-user2_backup.mount
</code></pre>
<hr />
<h3>8ï¸âƒ£ Cron noÄnÃ­ zÃ¡lohy</h3>
<h4>Rsync varianta</h4>
<pre><code class="language-bash">sudo nano /usr/local/bin/zalohuj_user1.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup
rsync -a --delete /data/ /mnt/user1_backup/
umount /mnt/user1_backup
cryptsetup luksClose user1_backup
</code></pre>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/zalohuj_user1.sh
crontab -e
</code></pre>
<pre><code>0 2 * * * /usr/local/bin/zalohuj_user1.sh
</code></pre>
<h4>BorgBackup varianta</h4>
<pre><code class="language-bash">sudo nano /usr/local/bin/borg_zalohuj_user1.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
export BORG_REPO=/mnt/user1_backup
export BORG_PASSPHRASE='TVE_HESLO'

cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

borg create --compression zstd,5 --stats ::'{hostname}-{now:%Y-%m-%d}' /data
borg prune -v --keep-daily=7 --keep-weekly=4 --keep-monthly=6

umount /mnt/user1_backup
cryptsetup luksClose user1_backup
</code></pre>
<p>PÅ™idÃ¡nÃ­ do crontab:</p>
<pre><code>0 2 * * * /usr/local/bin/borg_zalohuj_user1.sh
</code></pre>
<blockquote>
<p>âš ï¸ UchovÃ¡vej hesla oddÄ›lenÄ› â€“ napÅ™. <code>~/.borg-passphrase</code> s <code>chmod 600</code>.</p>
</blockquote>
<hr />
<h3>ğŸ§¼ Ãšklid &amp; testovÃ¡nÃ­</h3>
<ul>
<li>Testuj ruÄnÃ­ mount: <code>sudo systemctl start mnt-user1_backup.mount</code></li>
<li>Testuj cron pomocÃ­ <code>sudo run-parts /etc/cron.daily/</code> nebo naplÃ¡nuj <code>at now + 1 minute</code></li>
<li>Sleduj logy: <code>journalctl -xe</code>, <code>dmesg</code>, <code>systemctl status</code></li>
</ul>
<hr />
<h3>9ï¸âƒ£ ÄŒastÃ© problÃ©my a Å™eÅ¡enÃ­</h3>
<h4>ProblÃ©m: NVMe disk nenÃ­ detekovÃ¡n nebo boot nefunguje</h4>
<ul>
<li>Zkontroluj, zda mÃ¡Å¡ aktuÃ¡lnÃ­ bootloader (pÅ™Ã­kaz <code>vcgencmd bootloader_version</code>) a firmware ([Raspberry Pi Documentation, 2024]).  </li>
<li>Ujisti se, Å¾e NVMe disk je sprÃ¡vnÄ› zapojenÃ½ a napÃ¡jenÃ½ (nÄ›kterÃ© NVMe vyÅ¾adujÃ­ externÃ­ napÃ¡jenÃ­).  </li>
<li>Pokud nefunguje automatickÃ½ boot, zkus bootovat ze SD a zmÄ›nit boot order pomocÃ­ <code>raspi-config</code>.</li>
</ul>
<h4>ProblÃ©m: Nelze pÅ™ipojit Å¡ifrovanÃ½ kontejner</h4>
<ul>
<li>OvÄ›Å™ heslo nebo klÃ­ÄovÃ½ soubor.  </li>
<li>Zkontroluj, zda nenÃ­ kontejner poÅ¡kozen (<code>cryptsetup luksDump container_user1.img</code>).  </li>
<li>Pokud jsi pouÅ¾il klÃ­ÄovÃ½ soubor, ovÄ›Å™ sprÃ¡vnou cestu v <code>crypttab</code>.</li>
</ul>
<h4>ProblÃ©m: Borg backup hlÃ¡sÃ­ chybu pÅ™Ã­stupu</h4>
<ul>
<li>Zkontroluj prÃ¡va pÅ™Ã­stupu ke sloÅ¾kÃ¡m a sprÃ¡vnost promÄ›nnÃ½ch prostÅ™edÃ­.  </li>
<li>Heslo Borgu musÃ­ bÃ½t sprÃ¡vnÄ› nastaveno a dostupnÃ© bÄ›hem zÃ¡lohy.</li>
</ul>
<h4>ProblÃ©m: Cron joby neprobÃ­hajÃ­ sprÃ¡vnÄ›</h4>
<ul>
<li>PodÃ­vej se do logÅ¯ <code>journalctl -u cron</code> nebo <code>syslog</code>.  </li>
<li>Cron nevidÃ­ nÄ›kterÃ© promÄ›nnÃ© prostÅ™edÃ­ â€“ definuj je explicitnÄ› v skriptech.</li>
</ul>
<hr />
<h3>ğŸ”— OficiÃ¡lnÃ­ zdroje a dalÅ¡Ã­ ÄtenÃ­</h3>
<ul>
<li>Raspberry Pi Foundation (2024) <em>Bootloader and EEPROM</em>. DostupnÃ© z: https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#bootloader-and-eeprom [Cit. 2025-08-03].  </li>
<li>Raspberry Pi OS Documentation (2024) <em>Using NVMe Storage</em>. DostupnÃ© z: https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#nvme-storage [Cit. 2025-08-03].  </li>
<li>BorgBackup (2023) <em>Official Documentation</em>. DostupnÃ© z: https://borgbackup.readthedocs.io/en/stable/ [Cit. 2025-08-03].  </li>
<li>Cryptsetup (2023) <em>LUKS Disk Encryption</em>. DostupnÃ© z: https://gitlab.com/cryptsetup/cryptsetup/-/wikis/Home [Cit. 2025-08-03].  </li>
<li>Linux man pages (2025) <em>rsync(1), cryptsetup(8), systemd.mount(5)</em>. DostupnÃ© z: https://man7.org/linux/man-pages/ [Cit. 2025-08-03].</li>
</ul>
<hr />
<h3>âœ… CelkovÃ½ vÃ½sledek</h3>
<ul>
<li>âœ… SystÃ©m bÄ›Å¾Ã­ z NVMe  </li>
<li>âœ… Data zÃ¡lohovÃ¡na dennÄ› a Å¡ifrovanÄ›  </li>
<li>âœ… PÅ™Ã­stup pÅ™es SSH z LAN  </li>
<li>âœ… MoÅ¾nost pouÅ¾Ã­t i ruÄnÃ­ zÃ¡lohy  </li>
<li>âœ… BezpeÄnÃ© a snadno pÅ™enositelnÃ© kontejnery</li>
</ul>
<p><a href="../index.html">â† ZpÄ›t na pÅ™ehled</a></p>
</body>
</html>