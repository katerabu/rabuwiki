<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>rpinvme</title></head>
<body>
<h2>🛡️ Raspberry Pi 5: Přesun systému na NVMe + Šifrované zálohovací kontejnery</h2>
<hr />
<h3>📢 Úvodní banner</h3>
<blockquote>
<p><strong>Pozor:</strong> Tento návod předpokládá základní znalost Linuxu, práce s terminálem a zálohování dat.<br />
Před zahájením operací vždy proveď kompletní zálohu stávajícího systému.<br />
Nesprávné použití může vést ke ztrátě dat!</p>
</blockquote>
<hr />
<h3>📦 Seznam nutných balíčků</h3>
<p>Instaluj je předem, pokud ještě nejsou:</p>
<pre><code class="language-bash">sudo apt update
sudo apt install rsync cryptsetup borgbackup parted
</code></pre>
<hr />
<h3>1️⃣ Příprava</h3>
<h4>Nutnosti:</h4>
<ul>
<li>Raspberry Pi 5 s bootloaderem podporujícím NVMe (většina po roce 2023).</li>
<li>Funkční systém na SD kartě (<code>Raspberry Pi OS</code> 64bit doporučeno).</li>
<li>NVMe disk fyzicky připojen a správně detekován (<code>lsblk</code>, <code>blkid</code>).</li>
<li>Záloha systému před jakoukoliv operací: např. pomocí <code>rpi-clone</code>, <code>dd</code> nebo externí kopie na jiný disk.</li>
<li>Počítej s potřebou jednoho restartu po změně diskových oddílů (kvůli informování kernelu).</li>
</ul>
<hr />
<h3>2️⃣ Přesun systému na NVMe</h3>
<h4>a) Ověř připojení zařízení</h4>
<pre><code class="language-bash">lsblk
</code></pre>
<p>Hledej:
- SD karta = <code>/dev/mmcblk0</code>
- NVMe = <code>/dev/nvme0n1</code></p>
<h4>b) Vymaž a znovu vytvoř oddíly na NVMe</h4>
<pre><code class="language-bash">sudo umount /dev/nvme0n1*
sudo parted /dev/nvme0n1 mklabel gpt
sudo parted /dev/nvme0n1 mkpart primary ext4 0% 100%
sudo mkfs.ext4 /dev/nvme0n1p1
</code></pre>
<h4>c) Připoj nový oddíl a zkopíruj systém</h4>
<pre><code class="language-bash">sudo mkdir /mnt/nvme
sudo mount /dev/nvme0n1p1 /mnt/nvme
sudo rsync -aAXv / /mnt/nvme --exclude={&quot;/dev/*&quot;,&quot;/proc/*&quot;,&quot;/sys/*&quot;,&quot;/tmp/*&quot;,&quot;/run/*&quot;,&quot;/mnt/*&quot;,&quot;/media/*&quot;,&quot;/lost+found&quot;}
</code></pre>
<h4>d) Aktualizuj <code>fstab</code> v novém systému</h4>
<p>Zjisti UUID:</p>
<pre><code class="language-bash">sudo blkid
</code></pre>
<p>Pak uprav <code>/mnt/nvme/etc/fstab</code>:</p>
<pre><code>UUID=XXXX-XXXX / ext4 defaults,noatime 0 1
</code></pre>
<h4>e) Aktivuj boot z NVMe</h4>
<p>Buď:
- Odpoj SD kartu a restartuj (funguje u nového bootloaderu),
nebo:
- Spusť <code>sudo raspi-config</code> &gt; Advanced Options &gt; Boot Order &gt; NVMe
- Případně nainstaluj <code>rpi-eeprom</code> a zkontroluj firmware</p>
<hr />
<h3>3️⃣ Vytvoření šifrovaných zálohovacích kontejnerů</h3>
<h4>a) Instaluj <code>cryptsetup</code></h4>
<pre><code class="language-bash">sudo apt install cryptsetup
</code></pre>
<h4>b) Vytvoř šifrované soubory</h4>
<pre><code class="language-bash">cd /backup

# Kontejner 1
fallocate -l 10G container_user1.img
cryptsetup luksFormat container_user1.img
cryptsetup luksOpen container_user1.img user1_backup
mkfs.ext4 /dev/mapper/user1_backup
mkdir /mnt/user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

# Kontejner 2
fallocate -l 10G container_user2.img
cryptsetup luksFormat container_user2.img
cryptsetup luksOpen container_user2.img user2_backup
mkfs.ext4 /dev/mapper/user2_backup
mkdir /mnt/user2_backup
mount /dev/mapper/user2_backup /mnt/user2_backup
</code></pre>
<h4>c) Volitelný ruční mount skript</h4>
<pre><code class="language-bash">sudo nano /usr/local/bin/mount_backups.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup
cryptsetup luksOpen /backup/container_user2.img user2_backup
mount /dev/mapper/user2_backup /mnt/user2_backup
</code></pre>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/mount_backups.sh
</code></pre>
<hr />
<h3>4️⃣ Zálohování</h3>
<h4>a) Rsync (klient → RPi)</h4>
<pre><code class="language-bash">rsync -a --delete /data/ user@raspberrypi:/mnt/user1_backup/
</code></pre>
<h4>b) BorgBackup (moderní způsob)</h4>
<p>Na RPi:</p>
<pre><code class="language-bash">sudo apt install borgbackup
</code></pre>
<p>Na klientu:</p>
<pre><code class="language-bash">borg init --encryption=repokey-blake2 user@raspberrypi:/mnt/user1_backup
borg create -v --stats ::{hostname}-{now:%Y-%m-%d} /data
</code></pre>
<hr />
<h3>5️⃣ Přístup uživatelů</h3>
<ul>
<li>Přístup přes SSH.</li>
<li>Uživatel má právo číst/zapisovat do <code>/mnt/userX_backup</code>.</li>
<li>Používej klíčovou autentizaci.</li>
</ul>
<hr />
<h3>6️⃣ Bezpečnost</h3>
<ul>
<li>AES-XTS 512bit pomocí LUKS.</li>
<li>Kontejnery = snadno přenositelné + flexibilní.</li>
<li>Lze použít celý disk (LUKS přes <code>/dev/nvme0n1</code>), ale méně flexibilní.</li>
<li>Doporučujeme zálohovat mimo RPi (např. NAS).</li>
</ul>
<hr />
<h3>7️⃣ Automount přes systemd</h3>
<h4>a) crypttab</h4>
<pre><code class="language-bash">sudo nano /etc/crypttab
</code></pre>
<pre><code>user1_backup /backup/container_user1.img none luks
user2_backup /backup/container_user2.img none luks
</code></pre>
<p>Pokud chceš použít klíčový soubor:</p>
<pre><code class="language-bash">sudo mkdir -p /etc/keys
sudo dd if=/dev/urandom of=/etc/keys/user1.key bs=4096 count=1
sudo chmod 400 /etc/keys/user1.key
cryptsetup luksAddKey /backup/container_user1.img /etc/keys/user1.key
</code></pre>
<p>Pak do <code>crypttab</code>:</p>
<pre><code>user1_backup /backup/container_user1.img /etc/keys/user1.key luks
</code></pre>
<h4>b) mount jednotky</h4>
<pre><code class="language-bash">sudo nano /etc/systemd/system/mnt-user1_backup.mount
</code></pre>
<pre><code class="language-ini">[Unit]
Description=Mount user1 backup container
Requires=dev-mapper-user1_backup.device
After=dev-mapper-user1_backup.device

[Mount]
What=/dev/mapper/user1_backup
Where=/mnt/user1_backup
Type=ext4
Options=defaults

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Totéž pro user2:</p>
<pre><code class="language-bash">sudo nano /etc/systemd/system/mnt-user2_backup.mount
</code></pre>
<p>Aktivace:</p>
<pre><code class="language-bash">sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable mnt-user1_backup.mount
sudo systemctl enable mnt-user2_backup.mount
</code></pre>
<hr />
<h3>8️⃣ Cron noční zálohy</h3>
<h4>Rsync varianta</h4>
<pre><code class="language-bash">sudo nano /usr/local/bin/zalohuj_user1.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup
rsync -a --delete /data/ /mnt/user1_backup/
umount /mnt/user1_backup
cryptsetup luksClose user1_backup
</code></pre>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/zalohuj_user1.sh
crontab -e
</code></pre>
<pre><code>0 2 * * * /usr/local/bin/zalohuj_user1.sh
</code></pre>
<h4>BorgBackup varianta</h4>
<pre><code class="language-bash">sudo nano /usr/local/bin/borg_zalohuj_user1.sh
</code></pre>
<pre><code class="language-bash">#!/bin/bash
export BORG_REPO=/mnt/user1_backup
export BORG_PASSPHRASE='TVE_HESLO'

cryptsetup luksOpen /backup/container_user1.img user1_backup
mount /dev/mapper/user1_backup /mnt/user1_backup

borg create --compression zstd,5 --stats ::'{hostname}-{now:%Y-%m-%d}' /data
borg prune -v --keep-daily=7 --keep-weekly=4 --keep-monthly=6

umount /mnt/user1_backup
cryptsetup luksClose user1_backup
</code></pre>
<p>Přidání do crontab:</p>
<pre><code>0 2 * * * /usr/local/bin/borg_zalohuj_user1.sh
</code></pre>
<blockquote>
<p>⚠️ Uchovávej hesla odděleně – např. <code>~/.borg-passphrase</code> s <code>chmod 600</code>.</p>
</blockquote>
<hr />
<h3>🧼 Úklid &amp; testování</h3>
<ul>
<li>Testuj ruční mount: <code>sudo systemctl start mnt-user1_backup.mount</code></li>
<li>Testuj cron pomocí <code>sudo run-parts /etc/cron.daily/</code> nebo naplánuj <code>at now + 1 minute</code></li>
<li>Sleduj logy: <code>journalctl -xe</code>, <code>dmesg</code>, <code>systemctl status</code></li>
</ul>
<hr />
<h3>9️⃣ Časté problémy a řešení</h3>
<h4>Problém: NVMe disk není detekován nebo boot nefunguje</h4>
<ul>
<li>Zkontroluj, zda máš aktuální bootloader (příkaz <code>vcgencmd bootloader_version</code>) a firmware ([Raspberry Pi Documentation, 2024]).  </li>
<li>Ujisti se, že NVMe disk je správně zapojený a napájený (některé NVMe vyžadují externí napájení).  </li>
<li>Pokud nefunguje automatický boot, zkus bootovat ze SD a změnit boot order pomocí <code>raspi-config</code>.</li>
</ul>
<h4>Problém: Nelze připojit šifrovaný kontejner</h4>
<ul>
<li>Ověř heslo nebo klíčový soubor.  </li>
<li>Zkontroluj, zda není kontejner poškozen (<code>cryptsetup luksDump container_user1.img</code>).  </li>
<li>Pokud jsi použil klíčový soubor, ověř správnou cestu v <code>crypttab</code>.</li>
</ul>
<h4>Problém: Borg backup hlásí chybu přístupu</h4>
<ul>
<li>Zkontroluj práva přístupu ke složkám a správnost proměnných prostředí.  </li>
<li>Heslo Borgu musí být správně nastaveno a dostupné během zálohy.</li>
</ul>
<h4>Problém: Cron joby neprobíhají správně</h4>
<ul>
<li>Podívej se do logů <code>journalctl -u cron</code> nebo <code>syslog</code>.  </li>
<li>Cron nevidí některé proměnné prostředí – definuj je explicitně v skriptech.</li>
</ul>
<hr />
<h3>🔗 Oficiální zdroje a další čtení</h3>
<ul>
<li>Raspberry Pi Foundation (2024) <em>Bootloader and EEPROM</em>. Dostupné z: https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#bootloader-and-eeprom [Cit. 2025-08-03].  </li>
<li>Raspberry Pi OS Documentation (2024) <em>Using NVMe Storage</em>. Dostupné z: https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#nvme-storage [Cit. 2025-08-03].  </li>
<li>BorgBackup (2023) <em>Official Documentation</em>. Dostupné z: https://borgbackup.readthedocs.io/en/stable/ [Cit. 2025-08-03].  </li>
<li>Cryptsetup (2023) <em>LUKS Disk Encryption</em>. Dostupné z: https://gitlab.com/cryptsetup/cryptsetup/-/wikis/Home [Cit. 2025-08-03].  </li>
<li>Linux man pages (2025) <em>rsync(1), cryptsetup(8), systemd.mount(5)</em>. Dostupné z: https://man7.org/linux/man-pages/ [Cit. 2025-08-03].</li>
</ul>
<hr />
<h3>✅ Celkový výsledek</h3>
<ul>
<li>✅ Systém běží z NVMe  </li>
<li>✅ Data zálohována denně a šifrovaně  </li>
<li>✅ Přístup přes SSH z LAN  </li>
<li>✅ Možnost použít i ruční zálohy  </li>
<li>✅ Bezpečné a snadno přenositelné kontejnery</li>
</ul>
<p><a href="../index.html">← Zpět na přehled</a></p>
</body>
</html>